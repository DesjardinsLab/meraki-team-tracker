<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body {
        font-family: Calibri, Arial, Sans-serif;
      }
      img.action-call {
        width: 60px;
        height: 60px;
        opacity: 1;
        transition: opacity 1.5s ease-in-out;
        pointer-events: all;

        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px;
        border-radius: 50%;
        background-color: #FFFFFF;
      }
      img.action-call.success {
        content: url('./assets/ic_done.svg');
        background-color: #008c53;
      }
      img.action-call.failed {
        content: url('./assets/ic_clear.svg');
        background-color: #FF0000;
      }
      img.action-call.success, img.action-call.failed {
        pointer-events: none;
      }
      img.action-call.hidden {
        opacity: 0;
        pointer-events: none;
      }
      h1, h2 {
        font-weight: normal;
        font-family: 'PT Sans Narrow', sans-serif;
        text-transform: uppercase;
      }
      h1 {
        margin-left: 30px;
        font-size: 48px;
        margin-top: 50px;
      }
      .desc {
        margin: 2em 30px;
      }
      ul {
        display: flex;
        flex-wrap: wrap;
        list-style-type: none;
        margin: 0;
        padding: 0;
        margin-top: 20px;
      }
      li {
        width: 50%;
        margin-bottom: 40px;
        padding-left: 30px;
        box-sizing: border-box;
      }
      li .team-member-pic {
        position: relative;
        float: left;
        width: 20%;
      }
      li .team-member-pic img.team-member-avatar {
        width: 100%;
        height: auto;
        border-radius: 50%;
      }
      li .team-member-info {
        float: left;
        width: 80%;
        box-sizing: border-box;
        padding-left: 30px;
      }
      li .team-member-info h1 {
        font-size: 24px;
        margin: 0;
        margin-top: 10px;
        margin-bottom: 3px;
      }
      li .team-member-info h2 {
        font-weight: normal;
        font-size: 18px;
        margin: 0;
      }
      .meraki-thanks {
        margin-left: 30px;
        clear: both;
      }
      .meraki-logo {
        padding: 30px;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      window.call = function (id, cb) {
        if (!window.calling) {
          window.calling = true;
          fetch('/call/' + id, {
            method: 'POST',
            headers: new Headers({
              "Content-Type": 'application/json'
            }),
            // don't do this.
            body: JSON.stringify({secret: localStorage.secret})
          }).then(function (response) {
            if (response.status !== 200) {
              cb({err: response.statusText});
            } else {
              cb({});
            }
          }).catch(function (err) {
            cb({err: err});
          });
          window.calling = false;
        }
      };
    </script>
    <script type="text/javascript">
      var memberList = document.getElementById('memberList');
      if (!window.processing && !memberList) {
        window.processing = true;
        fetch('/team').then(function (response) {
          return response.json();
        }).then(function (members) {
          var content = document.createElement('DIV');
          var title = document.createElement('H1');

          title.appendChild(document.createTextNode('In attendance'));
          content.appendChild(title);

          var description = document.createElement('DIV');
          description.appendChild(document.createTextNode('The following people are in being detected by Meraki.'));
          description.className = 'desc';
          content.appendChild(description);

          var memberList = document.createElement('UL');
          memberList.setAttribute('id', 'memberList');

          var empty = true;
          for (var i in members) {
            // note that the members list was not empty.
            empty = false;
            var member = members[i];
            var memberElement = document.createElement('LI');
            memberElement.setAttribute('memberName', member.name);

            var pictureWrapper = document.createElement('DIV');
            pictureWrapper.className = 'team-member-pic';

            var picture = document.createElement('IMG');
            picture.setAttribute('src', member.img);
            picture.className = 'team-member-avatar';

            if (member.hasPhone) {
              // add call functionality
              var call = document.createElement('IMG');
              var callClass = 'action-call';
              var callHiddenClass = callClass + ' hidden';
              call.className = callHiddenClass;
              call.setAttribute('src', './assets/ic_notifications_active.svg');
              call.setAttribute('id', member.id);

              pictureWrapper.appendChild(call);

              pictureWrapper.addEventListener('touchend', function (event) {
                var calledElement = this.children[0];
                if (!this.callActive) {
                  this.callActive = true;
                  calledElement.className = callClass;
                  setTimeout(function() {
                    this.callActive = false;
                    calledElement.className = callHiddenClass;
                  }.bind(this), 7500);
                }
              });

              call.addEventListener('touchend', function () {
                // if call is not hidden
                if (this.className.indexOf('hidden') < 0) {
                  window.call(this.id, function (res) {
                    if (res.err) {
                      this.className = callHiddenClass + ' failed';
                    } else {
                      this.className = callHiddenClass + ' success';
                    }
                  }.bind(this));
                }
              });
            }

            pictureWrapper.appendChild(picture);
            memberElement.appendChild(pictureWrapper);

            var infoWrapper = document.createElement('DIV');
            infoWrapper.className = 'team-member-info';

            var name = document.createElement('H1');
            name.appendChild(document.createTextNode(member.name));
            infoWrapper.appendChild(name);

            memberElement.appendChild(infoWrapper);
            memberList.appendChild(memberElement);
          }

          var container = document.getElementById('presentMembers');

          if (!empty) {
            content.appendChild(memberList);

            if (container !== null) {
              container.appendChild(content);
            }
          } else {
            var emptyText = document.createElement('H1');
            emptyText.appendChild(document.createTextNode('There is no one here.'));
            container.appendChild(emptyText);
          }
          window.processing = false;
        }).catch(function (err) {
          console.log(err);
          var container = document.getElementById('presentMembers');
          var title = document.createElement('H1');

          title.appendChild(document.createTextNode('This page is not available right now.'));
          container.appendChild(title);
        });
      }
    </script>
    <div id='presentMembers' class='page-team'>
    </div>
    <div class='meraki-thanks'>
      This page is powered by:
    </div>
    <img class='meraki-logo' src='./assets/cisco-meraki.png'/>
  </body>
</html>
